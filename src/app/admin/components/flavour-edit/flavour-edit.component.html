<h1 mat-dialog-title>{{ title }}</h1>
<ng-container *ngIf="form">
    <div mat-dialog-content>
        <form clrForm [formGroup]="form" clrLayout="horizontal">
            <clr-input-container>
                <label for="name">Name</label>
                <input clrInput id="name" formControlName="name" class="form-control"/>
                <clr-control-error>Please enter a name</clr-control-error>
            </clr-input-container>

            <clr-select-container *ngIf="multiCloudEnabled">
                <label for="cloud">Cloud Provider</label>
                <select clrSelect id="cloud" formControlName="cloudClient" [compareWith]="compareCloudClient" (change)="onCloudChange()">
                    <option *ngFor="let cloudClient of cloudClients" [ngValue]="cloudClient">{{cloudClient?.name}}</option>
                </select>
                <clr-control-helper>Please select the cloud provider</clr-control-helper>
            </clr-select-container>

            <clr-select-container>
                <label for="flavour">Cloud flavour</label>
                <select clrSelect id="flavour" formControlName="cloudFlavour" [compareWith]="compareCloudFlavour">
                    <option *ngFor="let cloudFlavour of cloudFlavours" [ngValue]="cloudFlavour">{{cloudFlavour?.name}}</option>
                </select>
                <clr-control-helper>Please select a cloud flavour</clr-control-helper>
            </clr-select-container>

            <clr-input-container>
                <label for="memory">Memory</label>
                <input clrInput readonly id="memory" class="form-control" [value]="memory + ' GB'">
            </clr-input-container>

            <clr-input-container>
                <label for="cpu">CPUs</label>
                <input clrInput readonly id="cpu" class="form-control" [value]="cpu">
            </clr-input-container>

            <div class="clr-form-control clr-row">
                <label for="device" class="clr-control-label clr-col-12 clr-col-md-2">Devices</label>
                <div class="clr-control-container form-control clr-col-md-10 clr-col-12">
                    <div class="clr-input-wrapper">
                        <div class="clr-input form-control" style="border-bottom: 0;">
                           <span class="label" *ngFor="let deviceAllocation of deviceAllocations">
                                {{deviceAllocation | cloudDeviceAllocation}}
                           </span>
                        </div>
                    </div>
                </div>
            </div>

            <clr-combobox-container>
                <label for="instruments">Instruments</label>
                <clr-combobox clrMulti="true" id="instruments" formControlName="instruments">
                    <ng-container *clrOptionSelected="let selected">
                        {{selected?.name}}
                    </ng-container>
                    <clr-options>
                        <clr-option *clrOptionItems="let instrument of instruments;" [clrValue]="instrument">
                            {{instrument.name}}
                        </clr-option>
                    </clr-options>
                </clr-combobox>
                <clr-control-helper>Use of this flavour will be restricted to instruments selected here (and roles below)</clr-control-helper>
            </clr-combobox-container>

            <clr-combobox-container>
                <label for="roles">Roles</label>
                <clr-combobox clrMulti="true" id="roles" formControlName="roles">
                    <ng-container *clrOptionSelected="let selected">
                        {{selected?.name}}
                    </ng-container>
                    <clr-options>
                        <clr-option *clrOptionItems="let role of roles;" [clrValue]="role">
                            {{role.name}}
                        </clr-option>
                    </clr-options>
                </clr-combobox>
                <clr-control-helper>Use of this flavour will be restricted to roles selected here (and the instruments above)</clr-control-helper>
            </clr-combobox-container>

            <div class="section-title">Role-based instance lifetime rules</div>

            <div id="lifetime-roles" formArrayName="roleLifetimes">
                <div *ngFor="let rl of roleLifetimes.controls; let i = index" [formGroupName]="i" class="role-lifetimes-row">
                    <clr-combobox-container class="role-clr-container">
                        <label for="lifetime-role">Role</label>
                        <clr-combobox id="lifetime-role" formControlName="role">
                            <clr-options>
                                <clr-option *clrOptionItems="let role of availableRuleRoles; field: 'name'" [clrValue]="role">
                                    {{role.name}}
                                </clr-option>
                            </clr-options>
                        </clr-combobox>
                    </clr-combobox-container>

                    <clr-input-container class="role-clr-container">
                        <label for="lifetime-duration" class="role-clr-container-label">Lifetime</label>
                        <input id="lifetime-duration" clrInput formControlName="lifetimeText" placeholder="e.g. 2d, 12h, 1h30m, etc" class="clr-col-md-2"/>
                        <clr-control-error *ngIf="rl.get('lifetimeText')?.hasError('invalidDuration')" style="width: 180px">
                            Invalid duration format (use d, h, m â€” e.g. 2d3h30m)
                        </clr-control-error>
                    </clr-input-container>

                    <button type="button" class="btn btn-sm btn-outline-danger mt-3 role-clr-container" (click)="removeRoleLifetime(i)">
                        <clr-icon shape="trash"></clr-icon>
                    </button>
                </div>
            </div>

            <div class="mt-3 button-spacer">
                <button type="button" class="btn btn-sm btn-outline-primary" (click)="addRoleLifetime()">
                    <clr-icon shape="plus"></clr-icon> Add Rule
                </button>
            </div>


        </form>
        <div class="modal-footer">
            <button (click)="onCancel()" class="btn btn-outline">Cancel</button>
            <button (click)="submit()" [disabled]="form.invalid" class="btn btn-primary">Save</button>
        </div>
    </div>
</ng-container>

